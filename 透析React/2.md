### React Diff

---

å‚è€ƒï¼š
- [Reactä¹‹DOM Diffï¼šå¦‚ä½•å°†ç®—æ³•å¤æ‚åº¦æ§åˆ¶åœ¨O(n)](https://mp.weixin.qq.com/s/L0369dZ-yjUJxIGQK7U4gw)
- [ä» 0 å®ç°ä¸€ä¸ª React ç³»åˆ—ï¼ˆä¸‰ï¼‰ï¼šDiffç®—æ³•è¯¦è§£](https://mp.weixin.qq.com/s/Gm-W-S7WlDBVn9oQdaXNVQ)

#### diffåŸç†åŠæ€»ç»“
    - Reactçš„é«˜æ•ˆå¾—ç›Šäºå…¶Virtual DOM+React diffçš„ä½“ç³»ã€‚diffç®—æ³•å¹¶éreactç‹¬åˆ›ï¼Œreactåªæ˜¯åœ¨ä¼ ç»Ÿdiffç®—æ³•åšäº†ä¼˜åŒ–ã€‚ä½†å› ä¸ºå…¶ä¼˜åŒ–ï¼Œå°†diffç®—æ³•çš„æ—¶é—´å¤æ‚åº¦ä¸€ä¸‹å­ä»O(n^3)é™åˆ°O(n)ã€‚
    - React diffçš„ä¸‰å¤§ç­–ç•¥ï¼ˆä½¿ç”¨å¾ªç¯è€Œéé€’å½’ï¼Œé™ä½äº†å¤æ‚åº¦ï¼‰ï¼š
        1. Web UIä¸­DOMèŠ‚ç‚¹è·¨å±‚çº§çš„ç§»åŠ¨æ“ä½œç‰¹åˆ«å°‘ï¼Œå¯ä»¥å¿½ç•¥ä¸è®¡ã€‚
        
        2. æ‹¥æœ‰ç›¸åŒç±»çš„ä¸¤ä¸ªç»„ä»¶å°†ä¼šç”Ÿæˆç›¸ä¼¼çš„æ ‘å½¢ç»“æ„ï¼Œæ‹¥æœ‰ä¸åŒç±»çš„ä¸¤ä¸ªç»„ä»¶å°†ä¼šç”Ÿæˆä¸åŒçš„æ ‘å½¢ç»“æ„ã€‚
        
        3. å¯¹äºåŒä¸€å±‚çº§çš„ä¸€ç»„å­èŠ‚ç‚¹ï¼Œå®ƒä»¬å¯ä»¥é€šè¿‡å”¯ä¸€ id è¿›è¡ŒåŒºåˆ†ã€‚

    - åœ¨å¼€å‘ç»„ä»¶æ—¶ï¼Œä¿æŒç¨³å®šçš„ DOM ç»“æ„ä¼šæœ‰åŠ©äºæ€§èƒ½çš„æå‡ã€‚
    - åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå°½é‡å‡å°‘ç±»ä¼¼å°†æœ€åä¸€ä¸ªèŠ‚ç‚¹ç§»åŠ¨åˆ°åˆ—è¡¨é¦–éƒ¨çš„æ“ä½œã€‚
    - keyçš„å­˜åœ¨æ˜¯ä¸ºäº†æå‡diffæ•ˆç‡ï¼Œä½†æœªå¿…ä¸€å®šå°±å¯ä»¥æå‡æ€§èƒ½ï¼Œè®°ä½ç®€å•åˆ—è¡¨æ¸²æŸ“æƒ…å†µä¸‹ï¼Œä¸åŠ keyè¦æ¯”åŠ keyçš„æ€§èƒ½æ›´å¥½ã€‚
    - æ‡‚å¾—å€ŸåŠ©react diffçš„ç‰¹æ€§å»è§£å†³æˆ‘ä»¬å®é™…å¼€å‘ä¸­çš„ä¸€ç³»åˆ—é—®é¢˜ã€‚


#### ä¼ ç»ŸDiffç®—æ³•çš„ç“¶é¢ˆ

åœ¨å‰æ–‡ä¸­ï¼Œæˆ‘ä»¬å·²ç»äº†è§£åˆ°reactæ˜¯é€šè¿‡è™šæ‹ŸDOMçš„Diffæ¥çŸ¥æ™“åç»­çš„DOMçš„å˜æ›´æ“ä½œã€‚

ä½†æ˜¯ç”±äº Diff æ“ä½œæœ¬èº«ä¹Ÿä¼šå¸¦æ¥æ€§èƒ½æŸè€—ï¼ŒReactæ–‡æ¡£ä¸­æåˆ°ï¼Œå³ä½¿åœ¨æœ€å‰æ²¿çš„ç®—æ³•ä¸­ï¼Œå°†å‰åä¸¤æ£µæ ‘å®Œå…¨æ¯”å¯¹çš„ç®—æ³•çš„å¤æ‚ç¨‹åº¦ä¸º O(n 3 )ï¼Œå…¶ä¸­ n æ˜¯æ ‘ä¸­å…ƒç´ çš„æ•°é‡ã€‚

å¦‚æœåœ¨ React ä¸­ä½¿ç”¨äº†è¯¥ç®—æ³•ï¼Œé‚£ä¹ˆå±•ç¤º 1000ä¸ªå…ƒç´ æ‰€éœ€è¦æ‰§è¡Œçš„è®¡ç®—é‡å°†åœ¨åäº¿çš„é‡çº§èŒƒå›´ã€‚è¿™ä¸ªå¼€é”€å®åœ¨æ˜¯å¤ªè¿‡é«˜æ˜‚ã€‚

#### React Diff ä¼˜åŒ–ç­–ç•¥

React é€šè¿‡åˆ¶å®šå¤§èƒ†çš„ç­–ç•¥ï¼Œå°† O(n^3) å¤æ‚åº¦çš„é—®é¢˜è½¬æ¢æˆ O(n) å¤æ‚åº¦çš„é—®é¢˜ã€‚
1. Web UI ä¸­ DOM èŠ‚ç‚¹è·¨å±‚çº§çš„ç§»åŠ¨æ“ä½œç‰¹åˆ«å°‘ï¼Œå¯ä»¥å¿½ç•¥ä¸è®¡ã€‚å› æ­¤ä¸€ä¸ªDOMèŠ‚ç‚¹åœ¨å‰åä¸¤æ¬¡æ›´æ–°ä¸­è·¨è¶Šäº†å±‚çº§ï¼Œé‚£ä¹ˆReactä¸ä¼šå°è¯•å¤ç”¨ä»–ã€‚

    ![avatar](./images/2-1.png)

2. æ‹¥æœ‰ç›¸åŒç±»çš„ä¸¤ä¸ªç»„ä»¶å°†ä¼šç”Ÿæˆç›¸ä¼¼çš„æ ‘å½¢ç»“æ„ï¼Œæ‹¥æœ‰ä¸åŒç±»çš„ä¸¤ä¸ªç»„ä»¶å°†ä¼šç”Ÿæˆä¸åŒçš„æ ‘å½¢ç»“æ„ã€‚å¦‚æœå…ƒç´ ç”±divå˜ä¸ºpï¼ŒReactä¼šé”€æ¯divåŠå…¶å­å­™èŠ‚ç‚¹ï¼Œå¹¶æ–°å»ºpåŠå…¶å­å­™èŠ‚ç‚¹ã€‚
    - å¦‚æœæ˜¯åŒä¸€ç±»å‹çš„ç»„ä»¶ï¼ŒæŒ‰ç…§åŸç­–ç•¥ç»§ç»­æ¯”è¾ƒ virtual DOM treeã€‚
    - å¦‚æœä¸æ˜¯ï¼Œåˆ™å°†è¯¥ç»„ä»¶åˆ¤æ–­ä¸º dirty componentï¼Œä»è€Œæ›¿æ¢æ•´ä¸ªç»„ä»¶ä¸‹çš„æ‰€æœ‰å­èŠ‚ç‚¹ã€‚ï¼ˆ**æ­£å¦‚ React å®˜æ–¹åšå®¢æ‰€è¨€ï¼šä¸åŒç±»å‹çš„ component æ˜¯å¾ˆå°‘å­˜åœ¨ç›¸ä¼¼ DOM tree çš„æœºä¼šï¼Œå› æ­¤è¿™ç§æç«¯å› ç´ å¾ˆéš¾åœ¨å®ç°å¼€å‘è¿‡ç¨‹ä¸­é€ æˆé‡å¤§å½±å“çš„ã€‚**ï¼‰
    - å¯¹äºåŒä¸€ç±»å‹çš„ç»„ä»¶ï¼Œæœ‰å¯èƒ½å…¶ Virtual DOM æ²¡æœ‰ä»»ä½•å˜åŒ–ï¼Œå¦‚æœèƒ½å¤Ÿç¡®åˆ‡çš„çŸ¥é“è¿™ç‚¹é‚£å¯ä»¥èŠ‚çœå¤§é‡çš„ diff è¿ç®—æ—¶é—´ï¼Œå› æ­¤ React å…è®¸ç”¨æˆ·é€šè¿‡ shouldComponentUpdate() æ¥åˆ¤æ–­è¯¥ç»„ä»¶æ˜¯å¦éœ€è¦è¿›è¡Œ diffã€‚

3. å¯¹äºåŒä¸€å±‚çº§çš„ä¸€ç»„å­èŠ‚ç‚¹ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡ keyå±æ€§ æ¥æš—ç¤ºå“ªäº›å­å…ƒç´ åœ¨ä¸åŒçš„æ¸²æŸ“ä¸‹èƒ½ä¿æŒç¨³å®šã€‚
    - INSERT_MARKUPï¼Œæ–°çš„ component ç±»å‹ä¸åœ¨è€é›†åˆé‡Œï¼Œ å³æ˜¯å…¨æ–°çš„èŠ‚ç‚¹ï¼Œéœ€è¦å¯¹æ–°èŠ‚ç‚¹æ‰§è¡Œæ’å…¥æ“ä½œã€‚
    - REMOVE_NODEï¼Œè€ component ç±»å‹ï¼Œåœ¨æ–°é›†åˆé‡Œä¹Ÿæœ‰ï¼Œä½†å¯¹åº”çš„ element ä¸åŒåˆ™ä¸èƒ½ç›´æ¥å¤ç”¨å’Œæ›´æ–°ï¼Œéœ€è¦æ‰§è¡Œåˆ é™¤æ“ä½œï¼Œæˆ–è€…è€ component ä¸åœ¨æ–°é›†åˆé‡Œçš„ï¼Œä¹Ÿéœ€è¦æ‰§è¡Œåˆ é™¤æ“ä½œã€‚
    - MOVE_EXISTINGï¼Œåœ¨è€é›†åˆæœ‰æ–° component ç±»å‹ï¼Œä¸” element æ˜¯å¯æ›´æ–°çš„ç±»å‹ï¼ŒgenerateComponentChildren å·²è°ƒç”¨ receiveComponentï¼Œè¿™ç§æƒ…å†µä¸‹ prevChild=nextChildï¼Œå°±éœ€è¦åšç§»åŠ¨æ“ä½œï¼Œå¯ä»¥å¤ç”¨ä»¥å‰çš„ DOM èŠ‚ç‚¹ã€‚
#### React Fiber å®ç°

    - fiber æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œå¯ä»¥ç”¨çº¯jså¯¹è±¡è¡¨ç¤ºã€‚ä¸€ä¸ªfiber æ˜¯ä¸€ä¸ªæ‰§è¡Œå•å…ƒï¼Œæ¯æ¬¡æ‰§è¡Œä¸€ä¸ªä¼šæ£€æŸ¥è¿˜å‰©å¤šå°‘æ—¶é—´ï¼Œæ—¶é—´ä¸å¤Ÿåˆ™è®©æ¸¡æ§åˆ¶æƒã€‚
    - å®ƒå°†ä¸€ä¸ªä»»åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªå­ä»»åŠ¡ï¼Œå°†é€’å½’éå†ï¼ˆO(n^3)ï¼‰å˜ä¸ºå¾ªç¯éå†ï¼ˆO(n^1)ï¼‰ã€å¾ªç¯å¯ä»¥éšæ—¶ç»ˆæ­¢ï¼Œä¸”å¤æ‚åº¦ä½ï¼›é€’å½’ä¸å¯éšæ—¶ç»ˆæ­¢ï¼Œä¸”å¤æ‚åº¦é«˜ã€‘

#### React Diff å®ç°

###### Diffå…¥å£å‡½æ•°

    åœ¨å‡½æ•°å†…éƒ¨ï¼Œä¼šæ ¹æ®newChildç±»å‹è°ƒç”¨ä¸åŒçš„å¤„ç†å‡½æ•°ã€‚æˆ‘ä»¬å¯ä»¥ä»åŒçº§çš„èŠ‚ç‚¹æ•°é‡å°†Diffåˆ†ä¸ºä¸¤ç±»ï¼š
    - å½“newChildç±»å‹ä¸ºobjectã€numberã€stringï¼Œä»£è¡¨åŒçº§åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹
    - å½“newChildç±»å‹ä¸ºArrayï¼ŒåŒçº§æœ‰å¤šä¸ªèŠ‚ç‚¹

    ```
    // æ ¹æ®newChildç±»å‹é€‰æ‹©ä¸åŒdiffå‡½æ•°å¤„ç†
    function reconcileChildFibers(
    returnFiber: Fiber,
    currentFirstChild: Fiber | null,
    newChild: any
    ): Fiber | null {
    const isObject = typeof newChild === "object" && newChild !== null;

    if (isObject) {
        // objectç±»å‹ï¼Œå¯èƒ½æ˜¯ REACT_ELEMENT_TYPE æˆ– REACT_PORTAL_TYPE
        switch (newChild.$$typeof) {
        case REACT_ELEMENT_TYPE:
        // è°ƒç”¨ reconcileSingleElement å¤„ç†
        // ...å…¶ä»–case
        }
    }

    if (typeof newChild === "string" || typeof newChild === "number") {
        // è°ƒç”¨ reconcileSingleTextNode å¤„ç†
    }

    if (isArray(newChild)) {
        // è°ƒç”¨ reconcileChildrenArray å¤„ç†
    }

    // ä¸€äº›å…¶ä»–æƒ…å†µè°ƒç”¨å¤„ç†å‡½æ•°

    // ä»¥ä¸Šéƒ½æ²¡æœ‰å‘½ä¸­ï¼Œåˆ é™¤èŠ‚ç‚¹

    return deleteRemainingChildren(returnFiber, currentFirstChild);
    }
    ```
1. æƒ…å†µä¸€ï¼šåŒçº§åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹çš„Diff

    å¯¹äºå•ä¸ªèŠ‚ç‚¹ï¼Œæˆ‘ä»¬ä»¥ç±»å‹objectä¸ºä¾‹ï¼Œä¼šè¿›å…¥reconcileSingleElement
    ```
    const isObject = typeof newChild === 'object' && newChild !== null;
    if (isObject) {
        // å¯¹è±¡ç±»å‹ï¼Œå¯èƒ½æ˜¯ REACT_ELEMENT_TYPE æˆ– REACT_PORTAL_TYPE
        switch (newChild.$$typeof) {
        case REACT_ELEMENT_TYPE:
            // è°ƒç”¨ reconcileSingleElement å¤„ç†

            // ...å…¶ä»–case
        }
    }
    ```
    ![avatar](./images/2-2.png)
    å…¶ä¸­ç¬¬äºŒæ­¥åˆ¤æ–­DOMèŠ‚ç‚¹æ˜¯å¦å¯ä»¥å¤ç”¨ï¼Œè®©æˆ‘ä»¬é€šè¿‡ä»£ç çœ‹çœ‹æ˜¯å¦‚ä½•åˆ¤æ–­çš„ï¼š
    ```
    function reconcileSingleElement(
    returnFiber: Fiber,
    currentFirstChild: Fiber | null,
    element: ReactElement
    ): Fiber {
    const key = element.key;
    let child = currentFirstChild;
    // é¦–å…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨å¯¹åº”DOMèŠ‚ç‚¹
    while (child !== null) {
        // ä¸Šä¸€æ¬¡æ›´æ–°å­˜åœ¨DOMèŠ‚ç‚¹ï¼Œæ¥ä¸‹æ¥åˆ¤æ–­æ˜¯å¦å¯å¤ç”¨
        if (child.key === key) {
        // ğŸ™‹â€â™‚ï¸åŒå­¦çœ‹è¿™é‡Œï¼Œé¦–å…ˆæ¯”è¾ƒkeyæ˜¯å¦ç›¸åŒ
          switch (child.tag) {
            // ...çœç•¥case
            default: {
            if (child.elementType === element.type) {
                // ğŸ™‹â€â™‚ï¸åŒå­¦çœ‹è¿™é‡Œï¼Œkeyç›¸åŒåå†çœ‹typeæ˜¯å¦ç›¸åŒ
                // å¦‚æœç›¸åŒåˆ™è¡¨ç¤ºå¯ä»¥å¤ç”¨
                return existing;
            }
            // typeä¸åŒåˆ™è·³å‡ºå¾ªç¯
            break;
            }
          }
        // ğŸ‘¹ keyä¸åŒæˆ–typeä¸åŒéƒ½ä»£è¡¨ä¸èƒ½å¤ç”¨ï¼Œä¼šåˆ°è¿™é‡Œ
        // ä¸èƒ½å¤ç”¨çš„èŠ‚ç‚¹ï¼Œè¢«æ ‡è®°ä¸ºåˆ é™¤
        deleteRemainingChildren(returnFiber, child);
        break;
        } else {
        deleteChild(returnFiber, child);
        }
        child = child.sibling;
    }
    // åˆ›å»ºæ–°Fiberï¼Œå¹¶è¿”å›
    }

    ```
    ä»ä»£ç å¯ä»¥çœ‹å‡ºï¼ŒReacté€šè¿‡å…ˆåˆ¤æ–­keyæ˜¯å¦ç›¸åŒï¼Œå¦‚æœkeyç›¸åŒåˆ™åˆ¤æ–­typeæ˜¯å¦ç›¸åŒï¼Œåªæœ‰éƒ½ç›¸åŒæ—¶ä¸€ä¸ªDOMèŠ‚ç‚¹æ‰èƒ½å¤ç”¨ã€‚
2. æƒ…å†µäºŒï¼šåŒçº§æœ‰å¤šä¸ªå…ƒç´ çš„Diff
    è¿™ç§æƒ…å†µä¸‹ï¼ŒreconcileChildFibersçš„newChildå‚æ•°ä¸ºArrayï¼Œåœ¨å‡½æ•°å†…éƒ¨å¯¹åº”å¦‚ä¸‹æƒ…å†µï¼š
    ```
    if (isArray(newChild)) {
        // è°ƒç”¨ reconcileChildrenArray å¤„ç†
    }
    ```
    Reactå›¢é˜Ÿå‘ç°ï¼Œåœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œç›¸å¯¹äºå¢åŠ å’Œåˆ é™¤ï¼Œæ›´æ–°ç»„ä»¶å‘ç”Ÿçš„é¢‘ç‡æ›´é«˜ã€‚æ‰€ä»¥React Diffä¼šä¼˜å…ˆåˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦å±äºæ›´æ–°ã€‚
    
    è™½ç„¶æœ¬æ¬¡æ›´æ–°çš„JSXå¯¹è±¡newChildrenä¸ºæ•°ç»„å½¢å¼ï¼Œä½†æ˜¯å’ŒnewChildrenä¸­æ¯ä¸ªå€¼è¿›è¡Œæ¯”è¾ƒçš„æ˜¯ä¸Šæ¬¡æ›´æ–°çš„FiberèŠ‚ç‚¹ï¼ŒFiberèŠ‚ç‚¹çš„åŒçº§èŠ‚ç‚¹æ˜¯ç”±siblingæŒ‡é’ˆé“¾æ¥å½¢æˆçš„é“¾è¡¨ã€‚
    
    å³ newChildren[0]ä¸oldFiberæ¯”è¾ƒï¼ŒnewChildren[1]ä¸oldFiber.siblingæ¯”è¾ƒã€‚

    å•é“¾è¡¨æ— æ³•ä½¿ç”¨åŒæŒ‡é’ˆï¼Œæ‰€ä»¥æ— æ³•å¯¹ç®—æ³•ä½¿ç”¨åŒæŒ‡é’ˆä¼˜åŒ–ã€‚

    åŸºäºä»¥ä¸ŠåŸå› ï¼ŒDiffç®—æ³•çš„æ•´ä½“é€»è¾‘ä¼šç»å†ä¸¤è½®éå†ã€‚

    - ç¬¬ä¸€è½®éå†ï¼šå¤„ç†æ›´æ–°çš„èŠ‚ç‚¹ã€‚
     
        åˆ¤æ–­æ˜¯å¦å¯å¤ç”¨ï¼Œå¦‚æœä¸å¯ä»¥å¤ç”¨ï¼Œåˆ™ç«‹å³è·³å‡ºæ•´ä¸ªéå†ã€‚

        æœ€ç»ˆç»“æœæœ‰ä¸¤ç§ï¼š
        
        ï¼ˆ1ï¼‰newChildrenæ²¡æœ‰éå†å®Œï¼ŒoldFiberä¹Ÿæ²¡æœ‰éå†å®Œ

        ï¼ˆ2ï¼‰newChildrenéå†å®Œï¼Œæˆ–oldFiberéå†å®Œï¼Œæˆ–ä»–ä»¬åŒæ—¶éå†å®Œ
    
    - ç¬¬äºŒè½®éå†ï¼šå¤„ç†å‰©ä¸‹çš„ä¸å±äºæ›´æ–°çš„èŠ‚ç‚¹ã€‚
    
        ï¼ˆ1ï¼‰å¯¹äºç»“æœä¸€ï¼Œæˆ‘ä»¬åªéœ€è¦éå†å‰©ä¸‹çš„èŠ‚ç‚¹ï¼Œç»Ÿä¸€åšå¢åŠ å’Œåˆ é™¤çš„æ“ä½œå°±å¯ä»¥äº†ã€‚
        
        ï¼ˆ2ï¼‰å¯¹äºç»“æœäºŒï¼Œ**å¤„ç†ä½ç½®äº¤æ¢**ã€‚

###### å¤„ç†ä½ç½®äº¤æ¢

å› ä¸ºè¿™æ˜¯Diffç®—æ³•æœ€ç²¾é«“çš„éƒ¨åˆ†ï¼Œè¿™é‡Œæˆ‘ä»¬å•ç‹¬æ¥è¯´æ˜ã€‚

ç”±äºæœ‰èŠ‚ç‚¹äº¤æ¢äº†ä½ç½®ï¼Œæ‰€ä»¥ä¸èƒ½å†ç”¨ä½ç½®ç´¢å¼•å¯¹æ¯”å‰åçš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæ€æ ·æ‰èƒ½å°†åŒä¸€ä¸ªèŠ‚ç‚¹åœ¨ä¸¤æ¬¡æ›´æ–°ä¸­å¯¹åº”ä¸Šå‘¢ï¼Ÿ

ä½ ä¸€å®šæƒ³åˆ°äº†ï¼Œæˆ‘ä»¬éœ€è¦ç”¨keyå±æ€§äº†ã€‚

ä¸ºäº†å¿«é€Ÿçš„æ‰¾åˆ°keyå¯¹åº”çš„oldFiberï¼Œæˆ‘ä»¬å°†æ‰€æœ‰è¿˜æ²¡å¤„ç†çš„oldFiberæ”¾è¿›ä»¥keyå±æ€§ä¸ºkeyï¼ŒFiberä¸ºvalueçš„mapã€‚
```
const existingChildren = mapRemainingChildren(returnFiber, oldFiber);
```
å†éå†å‰©ä½™çš„newChildrenï¼Œé€šè¿‡newChildren[i].keyå°±èƒ½åœ¨existingChildrenä¸­æ‰¾åˆ°keyç›¸åŒçš„oldFiberã€‚

æˆ‘ä»¬åœ¨Diffå‡½æ•°çš„å…¥å£å¤„ï¼Œå®šä¹‰ä¸€ä¸ªå˜é‡
```
let lastPlacedIndex = 0;
```
è¯¥å˜é‡è¡¨ç¤ºå½“å‰æœ€åä¸€ä¸ªå¯å¤ç”¨èŠ‚ç‚¹ï¼Œå¯¹åº”çš„oldFiberåœ¨ä¸Šä¸€æ¬¡æ›´æ–°ä¸­æ‰€åœ¨çš„ä½ç½®ç´¢å¼•ã€‚æˆ‘ä»¬é€šè¿‡è¿™ä¸ªå˜é‡åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦éœ€è¦ç§»åŠ¨ã€‚

```
// ä¹‹å‰
abcd
// ä¹‹å
dabc

===ç¬¬ä¸€è½®éå†å¼€å§‹===
dï¼ˆä¹‹åï¼‰vs aï¼ˆä¹‹å‰ï¼‰
keyä¸å˜ï¼Œtypeæ”¹å˜ï¼Œä¸èƒ½å¤ç”¨ï¼Œè·³å‡ºéå†
===ç¬¬ä¸€è½®éå†ç»“æŸ===

===ç¬¬äºŒè½®éå†å¼€å§‹===
newChildren === dabcï¼Œæ²¡ç”¨å®Œï¼Œä¸éœ€è¦æ‰§è¡Œåˆ é™¤æ—§èŠ‚ç‚¹
oldFiber === abcdï¼Œæ²¡ç”¨å®Œï¼Œä¸éœ€è¦æ‰§è¡Œæ’å…¥æ–°èŠ‚ç‚¹

å°†å‰©ä½™oldFiberï¼ˆabcdï¼‰ä¿å­˜ä¸ºmap

ç»§ç»­éå†å‰©ä½™newChildren

// å½“å‰oldFiberï¼šabcd
// å½“å‰newChildren dabc

key === d åœ¨ oldFiberä¸­å­˜åœ¨
const oldIndex = dï¼ˆä¹‹å‰ï¼‰.index;
æ­¤æ—¶ oldIndex === 3; // ä¹‹å‰èŠ‚ç‚¹ä¸º abcdï¼Œæ‰€ä»¥d.index === 3
æ¯”è¾ƒ oldIndex ä¸ lastPlacedIndex;
oldIndex 3 > lastPlacedIndex 0
åˆ™ lastPlacedIndex = 3;
dèŠ‚ç‚¹ä½ç½®ä¸å˜

ç»§ç»­éå†å‰©ä½™newChildren

// å½“å‰oldFiberï¼šabc
// å½“å‰newChildren abc

key === a åœ¨ oldFiberä¸­å­˜åœ¨
const oldIndex = aï¼ˆä¹‹å‰ï¼‰.index; // ä¹‹å‰èŠ‚ç‚¹ä¸º abcdï¼Œæ‰€ä»¥a.index === 0
æ­¤æ—¶ oldIndex === 0;
æ¯”è¾ƒ oldIndex ä¸ lastPlacedIndex;
oldIndex 0 < lastPlacedIndex 3
åˆ™ aèŠ‚ç‚¹éœ€è¦å‘å³ç§»åŠ¨

ç»§ç»­éå†å‰©ä½™newChildren

é‡å¤açš„æ­¥éª¤...
```